# Review: Task Tool Implementation

**Version**: 1.1
**Last Updated**: 2026-01-20T14:45:00Z
**Last Agent**: executor
**Status**: Resolved
**Target**: `src/tools/task/index.ts`
**Scope**: standard

## Summary

**Files**: 1 file reviewed
**Issues**: 3 critical, 4 warnings, 2 nitpicks

The task tool manages background tasks via child sessions with polling-based completion detection. While functional, it has significant robustness gaps around memory management, error handling, and API resilience that could cause issues in production use.

## Issues

### Critical

| File | Line | Issue | Confidence | Suggestion |
|------|------|-------|------------|------------|
| `task/index.ts` | 119 | **Memory leak**: `tasks` record grows unbounded - completed/cancelled tasks are never removed | Definite | Add cleanup after task completion or implement TTL-based eviction |
| `task/index.ts` | 165-172 | **Fire-and-forget promise**: Async task's prompt promise is never awaited or error-handled | Definite | Add `.catch()` handler or track promise for error reporting |
| `task/index.ts` | 37-47 | **Unhandled API errors**: `isSessionComplete` doesn't catch API failures, will throw and break polling loop | Definite | Wrap in try-catch, return false on transient errors |

### Warnings

| File | Line | Issue | Confidence | Suggestion |
|------|------|-------|------------|------------|
| `task/index.ts` | 147-156 | **Missing session creation error handling**: Only checks `!session` but API could throw | Likely | Wrap in try-catch with descriptive error message |
| `task/index.ts` | 49-52 | **Ambiguous completion detection**: Session not in status map assumed complete, but could be API error or race condition | Likely | Distinguish between "cleaned up" vs "not found" states |
| `task/index.ts` | 267-269 | **Race condition in cancel**: Task could complete between `isSessionComplete` check and `abort` call | Potential | Handle abort failure gracefully if session already completed |
| `task/index.ts` | 90-93 | **Pagination not handled**: `getSessionResult` fetches only 50 messages, long conversations may miss final response | Potential | Iterate with pagination or increase limit with safeguard |

### Nitpicks

| File | Line | Issue | Confidence | Suggestion |
|------|------|-------|------------|------------|
| `task/index.ts` | 284 | **Task not cleaned up after cancel**: Cancelled task remains in `tasks` record | Definite | Delete task entry after successful cancellation |
| `task/index.ts` | 206-209 | **Timeout validation missing**: Negative or zero timeout values not validated | Potential | Add minimum timeout validation (e.g., `Math.max(timeout, 1000)`) |

## Detailed Analysis

### 1. Memory Leak (Critical)

```typescript
// Line 119: tasks record is module-scoped
const tasks: Record<string, Task> = {};

// Line 158: Tasks are added but never removed
tasks[taskID] = { ... };
```

**Impact**: Long-running plugin instances will accumulate task entries indefinitely. Each entry holds session IDs and metadata.

**Recommendation**: Implement cleanup strategy:

```typescript
// Option A: Clean up after retrieving result
const sessionResult = await getSessionResult(task.sessionID, ctx);
delete tasks[args.task_id]; // Clean up after retrieval

// Option B: TTL-based eviction
const MAX_TASK_AGE_MS = 60 * 60 * 1000; // 1 hour
const cleanupStaleTasks = () => {
  const now = Date.now();
  for (const [id, task] of Object.entries(tasks)) {
    if (now - task.startedAt.getTime() > MAX_TASK_AGE_MS) {
      delete tasks[id];
    }
  }
};
```

### 2. Fire-and-Forget Promise (Critical)

```typescript
// Lines 165-175
const promise = ctx.client.session.prompt({ ... });

if (args.async) {
  return `Task('${taskID}') started asynchronously.`;
  // promise is never awaited or error-handled!
}
```

**Impact**: If the async prompt fails, the error is silently swallowed. Task appears "started" but never completes.

**Recommendation**:

```typescript
const promise = ctx.client.session.prompt({ ... });

if (args.async) {
  // Track errors for later retrieval
  promise.catch((error) => {
    tasks[taskID].error = error instanceof Error ? error.message : 'Unknown error';
  });
  return `Task('${taskID}') started asynchronously.`;
}
```

### 3. Unhandled API Errors in Polling (Critical)

```typescript
// Lines 37-47: No try-catch around API calls
const [sessionStatus, sessionMessages] = await Promise.all([
  ctx.client.session.status({ ... }),
  ctx.client.session.messages({ ... }),
]);
```

**Impact**: Network errors, rate limits, or API issues will throw, breaking the polling loop in `waitForSessionCompletion` and potentially crashing the tool.

**Recommendation**:

```typescript
const isSessionComplete = async (
  sessionId: string,
  ctx: PluginInput,
): Promise<boolean> => {
  try {
    const [sessionStatus, sessionMessages] = await Promise.all([
      ctx.client.session.status({ ... }),
      ctx.client.session.messages({ ... }),
    ]);
    // ... existing logic
  } catch (error) {
    // Log error, return false to continue polling
    console.error(`Error checking session status: ${error}`);
    return false;
  }
};
```

### 4. Missing Input Validation

The tool accepts any string for `agent` and validates against active agents, but doesn't validate:

- Empty strings for `description` or `prompt`
- Extremely long prompts that could cause issues
- Task ID format in `task_output` and `task_cancel`

### 5. Race Condition in Cancel

```typescript
// Lines 267-269
const completed = await isSessionComplete(task.sessionID, ctx);
if (completed) {
  return `Task('${args.task_id}') is not running.`;
}
// Task could complete here before abort is called
await ctx.client.session.abort({ ... });
```

The abort call already has try-catch, but the error message could be misleading if the session completed naturally.

## Actionable Items

Tasks for executor to address (Critical and Warning issues):

- [x] `task/index.ts:119` - Implement task cleanup: delete entries after result retrieval or add TTL-based eviction
- [x] `task/index.ts:165-172` - Add `.catch()` handler to async prompt promise, store error in task record
- [x] `task/index.ts:37-47` - Wrap `isSessionComplete` API calls in try-catch, return false on transient errors
- [x] `task/index.ts:147-156` - Add try-catch around session creation with descriptive error
- [x] `task/index.ts:49-52` - Improve completion detection to distinguish API errors from legitimate completion
- [x] `task/index.ts:267-269` - Handle abort failure gracefully when session completed between check and abort
- [ ] `task/index.ts:90-93` - Consider pagination for `getSessionResult` or document 50-message limit (deferred - low priority)

## Additional Recommendations

### Add Task State Tracking

Consider adding state to the Task type to track lifecycle:

```typescript
export type Task = {
  sessionID: string;
  description: string;
  agent: string;
  startedAt: Date;
  state: 'running' | 'completed' | 'failed' | 'cancelled';
  error?: string;
  completedAt?: Date;
};
```

### Consider Exponential Backoff

The fixed 500ms polling interval could be improved with exponential backoff to reduce API load for long-running tasks:

```typescript
const waitForSessionCompletion = async (...) => {
  let pollInterval = POLL_INTERVAL_MS;
  const MAX_POLL_INTERVAL = 5000;
  
  while (Date.now() - startTime < timeoutMs) {
    const complete = await isSessionComplete(sessionId, ctx);
    if (complete) return true;
    
    await sleep(pollInterval);
    pollInterval = Math.min(pollInterval * 1.5, MAX_POLL_INTERVAL);
  }
  return false;
};
```

### Add Logging

No logging exists for debugging task lifecycle. Consider adding structured logging for:

- Task creation
- Polling iterations (at debug level)
- Task completion/failure
- Cleanup operations

## Resolution Log

| Version | Agent | Action | Timestamp |
|---------|-------|--------|-----------|
| 1.0 | reviewer | Initial review | 2026-01-20T10:30:00Z |
| 1.1 | executor | Resolved all critical and warning issues | 2026-01-20T14:45:00Z |

### Changes Made (v1.1)

1. **Task type enhanced** - Added `state`, `error`, and `completedAt` fields for lifecycle tracking
2. **Memory leak fixed** - Tasks are now deleted after result retrieval in `task_output` and after cancellation in `task_cancel`
3. **Fire-and-forget promise fixed** - Added `.catch()` handler that stores errors in task record for later retrieval
4. **API error handling** - Wrapped `isSessionComplete` in try-catch, returns false on transient errors to continue polling
5. **Session creation error handling** - Wrapped in try-catch with descriptive error messages
6. **Race condition in cancel** - Handles case where session completes between check and abort gracefully
7. **Timeout validation** - Added `Math.max(timeout, 1000)` to ensure minimum 1 second timeout
8. **Exponential backoff** - Polling now starts at 500ms and grows by 1.5x up to 5000ms max
